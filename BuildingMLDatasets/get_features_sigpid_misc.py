import csv
import os
import pandas as pd
import re


def gen_csv_header_row(txt_files):
    headers = ['sha256', 'apk_name']
    resource_dir = os.getcwd() + "/resources/"
    for txt_file in txt_files:
        with open(resource_dir + txt_file, 'r') as file:
            headers.extend(file.read().splitlines())
    return headers


def create_hashset_from_file(txt_file):
    hashset = set()
    with open(txt_file, 'r') as file:
        for line in file:
            hashset.add(line.strip())
    return hashset


def read_metrics_from_file(txt_file):
    metrics = []
    with open(txt_file, 'r') as file:
        for line in file:
            match = re.search(r':\s*([\d.]+)', line)
            if match:
                number = float(match.group(1))
                metrics.append(number)
    return metrics


def create_feature_hashes(parent, apk_folders):
    all_apks_features = []
    for apk_folder in apk_folders:
        feature_files_dir = parent + "/" + apk_folder
        apk_features_array = [apk_folder]
        for feature_file in os.listdir(feature_files_dir):
            if feature_file.endswith(('permissions.txt', 'intent-actions.txt', 'api-calls.txt', 'hw-sw.txt')):
                apk_features_array.append(create_hashset_from_file(feature_files_dir + "/" + feature_file))
            elif feature_file.endswith('metrics.txt'):
                apk_features_array.append(read_metrics_from_file(feature_files_dir + "/" + feature_file))
        all_apks_features.append(apk_features_array)
    return all_apks_features


def create_rows(main_df, all_apks_features_hashes):
    # main_df header info:
    # sha_256, apk_name, permissions(2 - 24), hw-sw actions (24 - 100), intent action (100 - 314), api calls (314 - 420)

    for apk in all_apks_features_hashes:
        apk_row = [0, apk[0]]  # 0 will be replaced with the sha256
        api_call_hashes = apk[1]
        hw_sw_hashes = apk[2]
        intent_action_hashes = apk[3]
        metrics_array = apk[4]
        permission_hashes = apk[5]

        # order inside apk: 1 -> api calls, 2 -> hw-sw, 3 -> intent action, 4 -> metrics, 5 -> permissions

        for permission in main_df.columns[2:24]:
            if permission in permission_hashes:
                apk_row.append(1)
            else:
                apk_row.append(0)

        for hw_sw in main_df.columns[24:100]:
            if hw_sw in hw_sw_hashes:
                apk_row.append(1)
            else:
                apk_row.append(0)

        for intent_action in main_df.columns[100:314]:
            if intent_action in intent_action_hashes:
                apk_row.append(1)
            else:
                apk_row.append(0)

        for api_call in main_df.columns[314:420]:
            if api_call in api_call_hashes:
                apk_row.append(1)
            else:
                apk_row.append(0)

        for metric_value in metrics_array:
            apk_row.append(metric_value)
        main_df.loc[len(main_df)] = apk_row


def main():
    # Creating header row for the csv file
    # TODO: Add metrics to the list of column headers
    headers_files = ['SigPid-permissions.txt', 'Mobitive-hwsw-list.txt', 'Mobitive-intent-actions.txt', 'BL-AMD-API-Calls.txt',
                     'metrics.txt']
    feature_column_names = gen_csv_header_row(headers_files)
    # Header length = 2 + 22 + 76 + 214 + 106 + 9 = 429
    main_df = pd.DataFrame(columns=feature_column_names)

    # Navigating to the directory with feature files and folders
    # This will be replaced with path to the hard drive with all the apk features
    library_dir = "C:/Users/sjind/ASingh/RESEARCH_ASSISTANT_MATERIAL/GITHUBREPO/FeatureExtraction/MobileDevice" \
                  "/ExtractedFeatures/"
    os.chdir(library_dir)
    parent_dir = os.getcwd()

    # Adding rows to the df
    apk_feature_folders = os.listdir()
    all_apks_features_hashes = create_feature_hashes(parent_dir, apk_feature_folders)
    create_rows(main_df, all_apks_features_hashes)

    # Creating output csv file
    current_file = os.path.abspath(__file__)
    current_directory = os.path.dirname(current_file)
    os.chdir(current_directory)
    main_df.to_csv("output/sigpid_misc_output.csv", index=False)


if __name__ == "__main__":
    main()
