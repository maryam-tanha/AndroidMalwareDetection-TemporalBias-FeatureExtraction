# Introduction 
This document goes over APK collection for benign and malicious APKs.

## Finding apps with a specific upload year from AndroZoo:

Upon navigating to this [lists page](https://androzoo.uni.lu/lists), you'll see a >2.7 GB compressed CSV file labeled <i>latest.csv.gz</i>. This file contains information on each APK present in the library.

The <b>sha256</b> column represents the unique primary key for each APK. Each row comprises the following column headers:  
'sha256', 'sha1', 'md5', 'apk_size', 'dex_size', 'dex_date', 'pkg_name', 'vercode', 'vt_detection', 'vt_scan_date', 'markets'

We downloaded this sizable compressed CSV file to filter the list, aiming to create a collection of sha256 keys associated with Goodware APKs categorized by year.

The [page](https://androzoo.uni.lu/lists) provides guidance on how to tailor the list according to our specific requirements. 

### Our proposed filtering process 

1) Filtering layer 1: The CSV file that is provided by AndroZoo (updated every day) is filtered according
to vt detection and market fields. vt detection) indicates the number of antiviruses that flagged the app as mal-
ware. If the value of this field is zero, the app is considered benign. We selected the apps with vt\_detection
more than or equal to 4 as malware. The market field for search is set to Google Play since the upload time is only available for such apps. The result of this step is two files that include metadata information about apps from Google Play. While one of the files includes the metadata for benign apps, the other one contains metadata about the malware. For instance, the command below is utilized to generate a textfile that includes metadata about benign apps from Google Play:  
```bash
echo "SHA256,Dex Date,VT_Detection,Market,pkg_name,ver_code" > benign_apks.txt && zcat latest.csv.gz | grep -v ',snaggamea' | awk -F, '{if ($8 == 0 && $11 ~ /play\.google\.com/) {print $1,$4,$8,$11,$6,$7} }' >> benign_apks.txt

```
**Note:** $8 == 0 in the above command, which ensures that vt_detection equals to 0 which means that no antivirus software detected the APK as a malware.

Here is an example for malware apps:
```bash
echo "SHA256,Dex Date,VT_Detection,Market,pkg_name,ver_code" > malware_apks.txt && zcat latest.csv.gz | grep -v ',snaggamea' | awk -F, '{if ($8 >= 4 && $11 ~ /play\.google\.com/) {print $1,$4,$8,$11,$6,$7} }' >> malware_apks.txt
```

2) Filtering layer 2 (optional): The generated files from step 1 are filtered based on an additional criteria, i.e., a
specific year in dex\_date of apps. 
The commands to apply both filtering layer 1 and filtering layer 2 are as follows:
For benign apps with year in dex\_date equal to 2021:
```bash
echo "SHA256,Dex Date,VT_Detection,Market,pkg_name,ver_code" > benign_apks_dex2021.txt && zcat latest.csv.gz | grep -v ',snaggamea' | awk -F, '{if ($8 == 0 && $4 >= "2021-01-01" && $4 < "2022-01-01" && $11 ~ /play\.google\.com/) {print $1,$4,$8,$11,$6,$7} }' >> benign_apks_dex2021.txt

```

For malware with year in dex\_date equal to 2021::

```bash
echo "SHA256,Dex Date,VT_Detection,Market,pkg_name,ver_code" > malware_apks_dex2021.txt && zcat latest.csv.gz | grep -v ',snaggamea' | awk -F, '{if ($8 >= 4 && $4 >= "2021-01-01" && $4 < "2022-01-01" && $11 ~ /play\.google\.com/) {print $1,$4,$8,$11,$6,$7} }' >> malware_apks_dex2021.txt

```
3) Filtering layer 3: We developed a Python script that searches the resultant files from step 1 or step 2 to filter
them based on a specific release year using the new API provided by AndroZoo in Dec 2023. The API call uses two parameters in the call:Package\_name and Version\_code.


** Non-matching scenario:
If we only apply filterimng step 1, then, we can create metadata for a number (e.g., 10,000 or 2,000) of valid benign/malware apps with a specific upload year using our developed Python script named, verify\_and\_extract.py:
```bash
python verify_and_extract.py -n 10000 -t b -y 2021 -k [AndroZoo API key] -i input_files/benign_apks.txt -csv results/2021/valid_2021_benign.csv
```
```bash
python verify_and_extract.py -n 2000 -t m -y 2021 -k [AndroZoo API key] -i input_files/malware_apks.txt -csv results/2021/valid_2021_malware.csv
```

**Matching scenario:
If we apply both filtering step 1 and 2, then, we can create a list of valid benign/malware apps with a specific upload year also have the same year in their dex\_date using our developed Python script named, extract\_matching\_dexdate_upload.py:
```bash
python extract_matching_dexdate_upload.py -t b -y 2021 -k [AndroZoo API key] -hf benign_apks_dex2021.txt -csv valid_dex2021_benign.csv
```

```bash
python extract_matching_dexdate_upload.py -t m -y 2021 -k [AndroZoo API key] -i input_files/malware_apks_dex2021.txt -csv results/2021/valid_dex2021_malware.csv
```
**Note:** If the input file is from step 2, then, the release year should be the same as the chosen year in that step. We can also indicate a stopping criteria for search, e.g., the number of apps that we want or simply search the whole file.

Now that we have created the list of valid apps, we move on to downloading the datasets from AndroZoo.



## Downloading APKs from AndroZoo (folder: DownloadAPKs):


**create_hash_list.py** gets the output csv file from the matching (e.g., valid\_dex2023\_benign.csv) or non-matching (e.g., valid\_2023\_benign.csv) scenario, as its input and extract the APK hashes. The hash list is the input to the get\_apk\_from_androzoo.py. create has

**get_apk_from_androzoo.py** allows you to download APK files from AndroZoo using a provided hash list and AndroZoo API key.

### Usage

#### Prerequisites

- Python 3.x
- Required Python packages (install using `pip install -r requirements.txt`):
  - `requests`
  - `tqdm`

#### Input Parameters

The script requires the following input parameters:

1. **api_key_file**: File containing the AndroZoo API key.
2. **hash_list_file**: File with a list of SHA256 hashes.
3. **output_dir**: Full path to the directory where downloaded APK files will be stored.

Optional parameter:

- **--num-workers**: Number of parallel processes to download APK files. Default is 40.

#### How to Obtain Input Parameters

1. **AndroZoo API Key**:
   - Obtain an API key from AndroZoo by registering on their [official website](https://androzoo.uni.lu/access).
   - Save the API key in a text file.

2. **Hash List File**:
   - Prepare a text file containing a list of SHA256 hashes, each on a new line.
   - More Information for this can be found in the above sections.

3. **Output Directory**:
   - Choose or create a directory where you want the downloaded APK files to be saved.

#### Running the Script

Execute the script using the following command:

```bash
python get_apk_from_androzoo.py <api_key_file> <hash_list_file> --num-workers <num_workers> <output_dir>
```

Replace `<api_key_file>`, `<hash_list_file>`, `<num_workers>`, and `<output_dir>` with the appropriate values.

## Example

```bash
python get_apk_from_androzoo.py androzoo_api_key.txt hash_list.txt --num-workers 30 ./output_apks
```

This command will download APK files using the specified AndroZoo API key, hash list, and output directory with 30 parallel workers.

## Note

- The script checks for the existence of downloaded files and their correctness using SHA256 hash values.
- If a file already exists with the correct hash, it skips the download for that file.
- If a file exists but has a different hash or is corrupted, it redownloads the file.




